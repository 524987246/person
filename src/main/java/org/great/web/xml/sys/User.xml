<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" 
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">


<mapper namespace="org.great.web.mapper.sys.UserMapper">


	<sql id="beanAttr">
		a.id,a.name,a.login_name AS "loginName",a.password,a.phone,
		a.isemploy,a.grade,a.dept
	</sql>
	<sql id="tableName">
		sys_user
	</sql>
	<resultMap id="userResult" type="org.great.web.bean.sys.User">
		<!-- 基本属性 -->
		<id property="id" column="id" />
		<result property="name" column="name" />
		<result property="createBy.id" column="createBy.id" />
		<result property="createDate" column="createDate" />
		<result property="updateBy.id" column="updateBy.id" />
		<result property="updateDate" column="updateDate" />
		<result property="remarks" column="remarks" />
		<result property="isemploy" column="isemploy" />
		<!--角色集合 -->
		<collection property="rolelist" ofType="org.great.web.bean.sys.Role">
			<id property="id" column="role.id" />
			<result property="name" column="role.name" />
			<result property="createBy.id" column="role.createBy.id" />
			<result property="createDate" column="role.createDate" />
			<result property="updateBy.id" column="role.updateBy.id" />
			<result property="updateDate" column="role.updateDate" />
			<result property="remarks" column="role.remarks" />
			<result property="isemploy" column="role.isemploy" />
		</collection>
		<!--菜单集合 -->
		<collection property="menulist" ofType="org.great.web.bean.sys.Menu">
			<id property="id" column="menu.id" />
			<result property="name" column="menu.name" />
			<result property="url" column="menu.url" />
			<result property="parentId" column="menu.parentId" />
			<result property="perms" column="menu.perms" />
			<result property="type" column="menu.type" />
			<result property="icon" column="menu.icon" />
			<result property="orderNum" column="menu.orderNum" />
			<result property="createBy.id" column="menu.createBy.id" />
			<result property="createDate" column="menu.createDate" />
			<result property="updateBy.id" column="menu.updateBy.id" />
			<result property="updateDate" column="menu.updateDate" />
			<result property="remarks" column="menu.remarks" />
			<result property="isemploy" column="menu.isemploy" />
		</collection>
	</resultMap>
	<!-- 查询单个用户,用于登录查找之类 -->
	<select id="get" resultMap="userResult"
		parameterType="org.great.web.bean.sys.User">
		select
		<include refid="beanAttr" />,
		e.id AS "role.id",
		e.name AS "role.name",
		e.create_by AS "role.createBy.id",
		DATE_FORMAT(e.create_date,'%Y-%m-%d') AS "role.createDate",
		e.update_by AS"menu.updateBy.id",
		DATE_FORMAT(e.update_date,'%Y-%m-%d') AS "role.updateDate",
		e.remarks
		AS "role.remarks",
		e.isemploy AS "role.isemploy"
		,
		d.id AS "menu.id",
		d.name AS "menu.name",
		d.url AS "menu.url",
		d.parent_id AS "menu.parentId",
		d.perms AS "menu.perms",
		d.type AS
		"menu.type",
		d.icon AS "menu.icon",
		d.order_num AS "menu.orderNum",
		d.create_by AS "menu.createBy.id",
		DATE_FORMAT(d.create_date,'%Y-%m-%d') AS "menu.createDate",
		d.update_by AS"menu.updateBy.id",
		DATE_FORMAT(d.update_date,'%Y-%m-%d') AS "menu.updateDate",
		d.remarks
		AS "menu.remarks",
		d.isemploy AS "menu.isemploy"
		from
		<include refid="tableName" /> a
		left join sys_user_role b 
		on b.user_id=a.id and b.isemploy=1
		left join sys_role_menu c
		on c.role_id=b.role_id and c.isemploy=1
		left join sys_menu d
		on d.id=c.menu_id and d.isemploy=1
		left join sys_role e 
		on b.role_id=e.id and e.isemploy=1
		<where>
			a.isemploy=1
			<if test="name !=null and name !=''">and a.name=#{name}</if>
			<if test="loginName !=null and loginName !=''">and a.login_name=#{loginName}</if>
			<if test="password !=null and password !=''">and a.password=MD5(#{password})</if>
		</where>
		GROUP BY d.id
	</select>
</mapper>